<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    
    <title>
        
        How to use Apache Avro Compression with Azure IoT, Azure Stream Analytics, and Node.js |
        
        Jon Gallant
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="azure,iot,avro,asa" />
    
    <meta name="description" content="I was recently working with a customer that uses Apache Avro compression and discovered that there isn‚Äôt a great example out there that shows you how to send Avro compressed messages through the IoT p">
<meta property="og:type" content="article">
<meta property="og:title" content="How to use Apache Avro Compression with Azure IoT, Azure Stream Analytics, and Node.js">
<meta property="og:url" content="https://blog.jongallant.com/2017/05/azure-iot-stream-analytics-avro-nodejs/index.html">
<meta property="og:site_name" content="Jon Gallant">
<meta property="og:description" content="I was recently working with a customer that uses Apache Avro compression and discovered that there isn‚Äôt a great example out there that shows you how to send Avro compressed messages through the IoT p">
<meta property="og:image" content="https://blog.jongallant.com/2017/05/azure-iot-stream-analytics-avro-nodejs/000188.png">
<meta property="og:updated_time" content="2018-12-11T02:49:05.075Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How to use Apache Avro Compression with Azure IoT, Azure Stream Analytics, and Node.js">
<meta name="twitter:description" content="I was recently working with a customer that uses Apache Avro compression and discovered that there isn‚Äôt a great example out there that shows you how to send Avro compressed messages through the IoT p">
<meta name="twitter:image" content="https://blog.jongallant.com/2017/05/azure-iot-stream-analytics-avro-nodejs/000188.png">
<meta name="twitter:creator" content="@jongallant">
    

    
    <link rel="alternate" href="http://feeds.feedburner.com/jongallant" title="Jon Gallant" type="application/atom+xml" />
    

    
    <link rel="icon" href="/favicon.ico" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <script type="text/javascript">
    (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-1148981-8', 'auto');
    ga('send', 'pageview');

</script>
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/">Leadership</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Career-Model/">Career Model</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Proactive-Mentorship/">Proactive Mentorship</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Productivity/">Productivity</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Review-Model/">Review Model</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Work-Life-Balance/">Work:Life Balance</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Musings/">Musings</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Reviews/">Reviews</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/">Tech</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/3D-Printing/">3D Printing</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Announcements/">Announcements</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Azure/">Azure</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Bugs/">Bugs</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Career/">Career</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Conferences/">Conferences</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/IoT/">IoT</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Jobs/">Jobs</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Microsoft/">Microsoft</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Power-BI/">Power BI</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Reviews/">Reviews</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Tips/">Tips</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Tutorial/">Tutorial</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Tutorials/">Tutorials</a></li></ul></li></ul>
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/archives/">Archive</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/videos/">Videos</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/contact/">Contact</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/category/Tech/">Tech</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/category/Tech/Azure/">Azure</a>
    </h1>
</div>

                        
                        <div class="main-body-content">
                            <div class="banner-ad">
                                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                                <!-- banner -->
                                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7253926757222509"
                                    data-ad-slot="8838481977" data-ad-format="auto" data-full-width-responsive="true"></ins>
                                <script>
                                    (adsbygoogle = window.adsbygoogle || []).push({});
                                </script>
                            </div>
                            <article id="post-azure-iot-stream-analytics-avro-nodejs" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        How to use Apache Avro Compression with Azure IoT, Azure Stream Analytics, and Node.js
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                
<a href="/2017/05/azure-iot-stream-analytics-avro-nodejs/" class="article-date">
    <time datetime="2017-05-03T21:32:50.000Z" itemprop="datePublished">2017-05-03</time>
</a>

                
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asa/">asa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/avro/">avro</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/azure/">azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iot/">iot</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>I was recently working with a customer that uses <a href="https://avro.apache.org/" target="_blank" rel="external">Apache Avro</a> compression and discovered that there isn‚Äôt a great example out there that shows you how to send Avro compressed messages through the IoT pipeline. This post will hopefully fill that gap.</p>
<p>Compression is a very common need in IoT scenarios because most large scale IoT solutions include message aggregation and compression before sending the messages across the wire.  IoT Hub itself ‚Äúsupports compression‚Äù because it doesn‚Äôt crack the message payload - it just treats the message as bytes across the wire. So, the cloud endpoint (IoT Hub) isn‚Äôt an issue. The issue arises when we need to use compression and then process those messages post-ingestion. Azure Stream Analytics, a common Azure IoT message ingestor, supports JSON, CSV and Avro.  Gzip/Deflate are not supported, but the request has been made into the ASA team to support them. In the meantime, this post will demonstrate how to get Avro to work through the IoT pipeline and unblock those customers that want compression and are considering Avro. If you need to support Gzip/Deflate or any other compression mechanism, then you will need to process your IoT Hub messages via the backing Event Hub using Event Processor Host via Azure Functions, Service Fabric or any custom application.</p>
<p>The architecture for this walkthrough is as follows:</p>
<p>A <strong>Node.js</strong> script reads telemetry data from sensors, compresses that data with <strong>Avro</strong> and then sends to <strong>IoT Hub</strong>. An <strong>Azure Stream Analytics (ASA)</strong> job picks up those messages and forwards them to <strong>Azure Blob Storage</strong> as JSON objects.</p>
<p>You can follow along to build this entire example from scratch or you can click <a href="#Run-Avro-Script">here</a>, if you just want to jump to the Avro code.</p>
<h2 id="tools"><a class="header-anchor" href="#tools"></a>Tools</h2>
<h3 id="azure-cli-2-0"><a class="header-anchor" href="#azure-cli-2-0"></a>Azure CLI 2.0</h3>
<p>You have three options for creating the Azure resources required for this example. <strong>I will use Azure CLI 2.0 in this post.</strong></p>
<p>1. <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" target="_blank" rel="external">Azure CLI 2.0</a><br>
2. <a href="https://docs.microsoft.com/en-us/azure/cli-install-nodejs" target="_blank" rel="external">Azure CLI 1.0</a><br>
3. <a href="https://portal.azure.com" target="_blank" rel="external">Azure Portal</a></p>
<p>Follow the steps <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" target="_blank" rel="external">here to install Azure CLI 2.0</a>.</p>
<h3 id="iothub-explorer"><a class="header-anchor" href="#iothub-explorer"></a>iothub-explorer</h3>
<p>We will use the iothub-explorer to monitor messages that are sent to IoT Hub.</p>
<p>Follow the steps <a href="https://github.com/Azure/iothub-explorer" target="_blank" rel="external">here to install the iothub-explorer</a>.</p>
<p>You could also use the Windows Form version called the <a href="https://github.com/Azure/azure-iot-sdk-csharp/tree/master/tools/DeviceExplorer#download" target="_blank" rel="external">Device Explorer</a>.</p>
<h3 id="azure-storage-explorer"><a class="header-anchor" href="#azure-storage-explorer"></a>Azure Storage Explorer</h3>
<p>We will use Azure Storage Explorer to view the outputted messages that are sent to Blob storage from the ASA job.</p>
<p>Follow the steps <a href="http://storageexplorer.com/" target="_blank" rel="external">here to install the Azure Storage Explorer</a>.</p>
<h2 id="iot-hub"><a class="header-anchor" href="#iot-hub"></a>IoT Hub</h2>
<h3 id="create-iot-hub"><a class="header-anchor" href="#create-iot-hub"></a>Create IoT Hub</h3>
<p>Follow the steps <a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-create-using-cli" target="_blank" rel="external">here to create an Azure IoT Hub using the Azure CLI 2.0</a>.</p>
<h3 id="get-iot-hub-connection-string"><a class="header-anchor" href="#get-iot-hub-connection-string"></a>Get IoT Hub Connection String</h3>
<p>Execute the following command to get the connection string for the IoT Hub you just created.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">az iot hub show-connection-string --hub-name [your IoT Hub name]</div></pre></td></tr></table></figure>
<p>Copy that connection string to a safe place. You will need it later.</p>
<h3 id="create-iot-hub-device"><a class="header-anchor" href="#create-iot-hub-device"></a>Create IoT Hub Device</h3>
<p>Execute the following command to create a new IoT Hub device.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">az iot device create --hub-name [your IoT Hub name] --device-id [your IoT Hub device name]</div></pre></td></tr></table></figure>
<h3 id="get-device-connection-string"><a class="header-anchor" href="#get-device-connection-string"></a>Get Device Connection String</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">az iot device show-connection-string --hub-name [your IoT Hub name] --device-id [your IoT Hub device name]</div></pre></td></tr></table></figure>
<p>Copy that device‚Äôs connection string to a safe place. You will need it later.</p>
<h3 id="create-iot-hub-consumer-group"><a class="header-anchor" href="#create-iot-hub-consumer-group"></a>Create IoT Hub Consumer Group</h3>
<p>You will need a new IoT Hub consumer group when you configure ASA later.  Let‚Äôs create it now with the following command:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">az iot hub consumer-group create --hub-name [your IoT Hub name] --name avrocg</div></pre></td></tr></table></figure>
<h2 id="start-monitoring-events"><a class="header-anchor" href="#start-monitoring-events"></a>Start Monitoring Events</h2>
<p>Execute the following command to monitor events for the device you just created:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">iothub-explorer monitor-events [your IoT Hub device name] --login <span class="string">"[your IoT Hub connection string goes here]"</span></div></pre></td></tr></table></figure>
<p>You will see the following output:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Monitoring events from device avro-device...</div></pre></td></tr></table></figure>
<p>Keep that command open, we‚Äôll come back to it in a minute.</p>
<h2 id="run-avro-script"><a class="header-anchor" href="#run-avro-script"></a>Run Avro Script</h2>
<p>We will now get the Node.js code that will compress messages with Avro and send them to IoT Hub.</p>
<p>Let‚Äôs get it running and then go through code.</p>
<h3 id="install-node-js-and-git"><a class="header-anchor" href="#install-node-js-and-git"></a>Install Node.js and git</h3>
<p>Make sure you have <a href="https://nodejs.org/en/download/" target="_blank" rel="external">Node.js</a> and <a href="https://git-scm.com/downloads" target="_blank" rel="external">git</a> installed.</p>
<h3 id="clone-repo"><a class="header-anchor" href="#clone-repo"></a>Clone Repo</h3>
<p>Open up a command prompt, navigate to an empty folder and execute the following command.  This will copy the code to a local folder.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/jongio/azure-iot-stream-analytics-avro-nodejs.git</div></pre></td></tr></table></figure>
<h3 id="install-node-js-packages"><a class="header-anchor" href="#install-node-js-packages"></a>Install Node.js Packages</h3>
<p>Change to the directory that contains the code you just cloned and execute the following command to get the Node.js packages locally.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">npm i</div></pre></td></tr></table></figure>
<h3 id="setup-config"><a class="header-anchor" href="#setup-config"></a>Setup Config</h3>
<p>This script uses <a href="https://www.npmjs.com/package/dotenv" target="_blank" rel="external">dotenv</a> to allow you to set an IoT Hub connection string in a .env file.</p>
<p>Rename ‚Äú.env.sample‚Äù to ‚Äú.env‚Äù and paste your <strong>device</strong> connection string that you saved earlier. If you are using Windows, then name the file .env. (with the . at the end) and Windows will automatically change it to .env for you.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">iotHubConnectionString=[your device<span class="string">'s connection string goes here]</span></div></pre></td></tr></table></figure>
<h3 id="run-script"><a class="header-anchor" href="#run-script"></a>Run Script</h3>
<p>Execute the following to start sending messages to IoT Hub.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">node index.js</div></pre></td></tr></table></figure>
<p>You will now see the following output:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Connected to IoT Hub</div><div class="line">Sending message: Obj‚ïî‚ïùavro.schemaÔøΩ‚ïî&#123;<span class="string">"name"</span>:<span class="string">"telemetry"</span>,<span class="string">"type"</span>:<span class="string">"record"</span>,<span class="string">"fields"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"deviceId"</span>,<span class="string">"type"</span>:<span class="string">"string"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"windSpeed"</span>,<span class="string">"type"</span>:<span class="string">"float"</span>&#125;]&#125;avro.codecdeflate &#125;4ÎòëÔøΩ%ÔøΩÔøΩ</div><div class="line">                                                                                                                                                                                    ÔøΩÔøΩEÔøΩÔøΩx‚ïóÔøΩKI-ÔøΩLN5ÔøΩÔøΩ</div><div class="line">&#125;4ÎòëÔøΩ%ÔøΩÔøΩ</div><div class="line">        ÔøΩÔøΩEÔøΩÔøΩx</div><div class="line">send status: MessageEnqueued</div><div class="line">Sending message: Obj‚ïî‚ïùavro.schemaÔøΩ‚ïî&#123;<span class="string">"name"</span>:<span class="string">"telemetry"</span>,<span class="string">"type"</span>:<span class="string">"record"</span>,<span class="string">"fields"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"deviceId"</span>,<span class="string">"type"</span>:<span class="string">"string"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"windSpeed"</span>,<span class="string">"type"</span>:<span class="string">"float"</span>&#125;]&#125;avro.codecdeflate ÔøΩ7ÔøΩzXNObQU&#125;ÔøΩÔøΩ‚ïóÔøΩKI-ÔøΩLN5ÔøΩ=ÔøΩ</div><div class="line">ÔøΩ7ÔøΩzXNObQU&#125;ÔøΩÔøΩ</div><div class="line">send status: MessageEnqueued</div><div class="line">Sending message: Obj‚ïî‚ïùavro.schemaÔøΩ‚ïî&#123;<span class="string">"name"</span>:<span class="string">"telemetry"</span>,<span class="string">"type"</span>:<span class="string">"record"</span>,<span class="string">"fields"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"deviceId"</span>,<span class="string">"type"</span>:<span class="string">"string"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"windSpeed"</span>,<span class="string">"type"</span>:<span class="string">"float"</span>&#125;]&#125;avro.codecdeflate ÔøΩÔøΩbÔøΩzjÔøΩÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩ‚ïóÔøΩKI-ÔøΩLN5</div><div class="line">                                                                                                                                                                                                   ÔøΩ</div><div class="line"></div><div class="line">p‚ïù ÔøΩÔøΩbÔøΩzjÔøΩÔøΩÔøΩÔøΩ[ÔøΩÔøΩÔøΩ</div><div class="line">send status: MessageEnqueued</div></pre></td></tr></table></figure>
<h3 id="monitor-messages-coming-into-iot-hub"><a class="header-anchor" href="#monitor-messages-coming-into-iot-hub"></a>Monitor Messages Coming into IoT Hub</h3>
<p>Switch back to the command prompt with iothub-explorer open and you will now start to see events outputted:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">==== From: avro ====</div><div class="line">Objavro.schemaÔøΩ&#123;<span class="string">"name"</span>:<span class="string">"telemetry"</span>,<span class="string">"type"</span>:<span class="string">"record"</span>,<span class="string">"fields"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"deviceId"</span>,<span class="string">"type"</span>:<span class="string">"string"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"windSpeed"</span>,<span class="string">"type"</span>:<span class="string">"float"</span>&#125;]&#125;avro.codecdeflate K=ÔøΩ8h&#123;ÔøΩ!ÔøΩÔøΩÔøΩngÔøΩqÔøΩKI-ÔøΩLN5ÔøΩÔøΩ1r K=ÔøΩ8h&#123;ÔøΩ!ÔøΩÔøΩÔøΩngÔøΩq</div><div class="line">====================</div><div class="line">==== From: avro ====</div><div class="line">Objavro.schemaÔøΩ&#123;<span class="string">"name"</span>:<span class="string">"telemetry"</span>,<span class="string">"type"</span>:<span class="string">"record"</span>,<span class="string">"fields"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"deviceId"</span>,<span class="string">"type"</span>:<span class="string">"string"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"windSpeed"</span>,<span class="string">"type"</span>:<span class="string">"float"</span>&#125;]&#125;avro.codecdeflate ”£ ÔøΩÔøΩﬁâÔøΩ]<span class="comment">#ÔøΩÔøΩTÔøΩÔøΩÔøΩKI-ÔøΩLN5\ÔøΩÔøΩÔøΩ ”£ ÔøΩÔøΩﬁâÔøΩ]#ÔøΩÔøΩTÔøΩÔøΩ</span></div><div class="line">====================</div></pre></td></tr></table></figure>
<h2 id="inspect-avro-script"><a class="header-anchor" href="#inspect-avro-script"></a>Inspect Avro Script</h2>
<p>Now that we have it running, let‚Äôs take a look at the script to see how it works.</p>
<p>You can see the full code on GitHub <a href="https://github.com/jongio/azure-iot-stream-analytics-avro-nodejs/blob/master/index.js" target="_blank" rel="external">here</a>. There are lots of comments inline that should help you see how it all works together.</p>
<p>The script uses following npm packages: <a href="https://www.npmjs.com/package/avsc" target="_blank" rel="external">avsc</a>, <a href="https://www.npmjs.com/package/memory-streams" target="_blank" rel="external">memory-streams</a>, <a href="https://www.npmjs.com/package/azure-iot-device" target="_blank" rel="external">azure-iot-device</a> and <a href="https://www.npmjs.com/package/azure-iot-device-amqp" target="_blank" rel="external">azure-iot-device-amqp</a>.</p>
<p>With Avro, you can embed the payload schema into the Avro Container file.  In this repo, we have a file called <code>schema.avsc</code>, which looks like this:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"telemetry"</span>,</div><div class="line">    <span class="attr">"type"</span>: <span class="string">"record"</span>,</div><div class="line">    <span class="attr">"fields"</span>: [</div><div class="line">        &#123; <span class="attr">"name"</span>: <span class="string">"deviceId"</span>, <span class="attr">"type"</span>: <span class="string">"string"</span> &#125;,</div><div class="line">        &#123; <span class="attr">"name"</span>: <span class="string">"windSpeed"</span>, <span class="attr">"type"</span>: <span class="string">"float"</span> &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In fact, ASA requires the schema to be embedded into the message payload.</p>
<p>This file Avro type is loaded via the parse method like this:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">const</span> type = avro.parse(__dirname + <span class="string">'/schema.avsc'</span>);</div></pre></td></tr></table></figure>
<p>At the moment, ASA does not support ENUMs in your Avro schema. Convert the ENUM to string if you are having issues.  I will update this post when that has been resolved.</p>
<p>The meat of the code is as follows:</p>
<ul>
<li>Instantiate a BlockEncoder with deflate codec</li>
<li>Instantiate a WriteableStream and pipe BlockEncoder writes to it.</li>
<li>Write to the BlockEncoder</li>
<li>Call BlockEncoder.end();</li>
<li>Send IoT Hub message in the ‚Äòend‚Äô event handler, which calls WriateableStream.toBuffer()</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Instantiate a BlockEncoder, which allows you to write avro into a buffer.</span></div><div class="line"><span class="keyword">var</span> avroEncoder = <span class="keyword">new</span> avro.streams.BlockEncoder(type, &#123; <span class="attr">codec</span>: <span class="string">'deflate'</span> &#125;); <span class="comment">// Choose 'deflate' or it will default to 'null'</span></div><div class="line"></div><div class="line"><span class="comment">// Instantiate a stream to write the avro buffer to, which we'll send to IoT Hub</span></div><div class="line"><span class="keyword">var</span> writer = <span class="keyword">new</span> streams.WritableStream();</div><div class="line">avroEncoder.pipe(writer);</div><div class="line"></div><div class="line"><span class="comment">// Generate the faux json</span></div><div class="line"><span class="keyword">var</span> windSpeed = <span class="number">10</span> + (<span class="built_in">Math</span>.random() * <span class="number">4</span>); <span class="comment">// range: [10, 14]</span></div><div class="line"><span class="keyword">var</span> json = &#123; <span class="attr">deviceId</span>: <span class="string">'device1'</span>, <span class="attr">windSpeed</span>: windSpeed &#125;;</div><div class="line"></div><div class="line"><span class="comment">// Write the json</span></div><div class="line"><span class="keyword">if</span> (type.isValid(json)) &#123;</div><div class="line">    avroEncoder.write(json);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Call end to tell avro we are done writing and to trigger the end event.</span></div><div class="line">avroEncoder.end();</div><div class="line"></div><div class="line"><span class="comment">// end event was triggered, get the avro data from the piped stream and send to IoT Hub.</span></div><div class="line">avroEncoder.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// call toBuffer on the WriteableStream and pass to IoT Hub message ctor</span></div><div class="line">    <span class="keyword">var</span> message = <span class="keyword">new</span> Message(writer.toBuffer());</div><div class="line"></div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Sending message: '</span> + message.getData());</div><div class="line">    client.sendEvent(message, printResultFor(<span class="string">'send'</span>));</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>While this seems like a pretty straight forward script, it took me a while to get it all working.  In the process, I collected the following Avro related resources:</p>
<ul>
<li><a href="https://github.com/mtth/avsc/" target="_blank" rel="external">Avro Node.js Library: mtth/avsc</a></li>
<li><a href="http://www.michael-noll.com/blog/2013/03/17/reading-and-writing-avro-files-from-the-command-line/" target="_blank" rel="external">Reading and Writing Avro Files From the Command Line</a></li>
<li><a href="https://nodejs.org/api/stream.html" target="_blank" rel="external">Node.js Stream Docs</a></li>
<li><a href="http://codewinds.com/blog/2013-08-31-nodejs-duplex-streams.html" target="_blank" rel="external">Creating duplex streams with Node.js</a></li>
<li><a href="https://stackoverflow.com/questions/39045356/how-to-send-compacted-data-to-azure-stream-analytics" target="_blank" rel="external">How to send compacted data to Azure Stream Analytics?</a></li>
<li><a href="https://blogs.msdn.microsoft.com/streamanalytics/2015/10/28/sending-and-consuming-events-in-avro-format/" target="_blank" rel="external">Sending and consuming events in Avro format</a></li>
<li><a href="https://github.com/mtth/avsc/issues/75" target="_blank" rel="external">Rotate stream into google cloud storage #75</a></li>
<li><a href="https://github.com/mtth/avsc/issues/17" target="_blank" rel="external">BlockEncoder produces invalid avro format? #17</a></li>
<li><a href="https://github.com/miguno/avro-cli-examples" target="_blank" rel="external">avro-cli-examples</a></li>
</ul>
<h2 id="azure-blob-storage"><a class="header-anchor" href="#azure-blob-storage"></a>Azure Blob Storage</h2>
<p>For this contrived exercise, we‚Äôre going to configure a Blob Storage account that ASA sends all messages to.  Let‚Äôs create the account and then wire up ASA.</p>
<h2 id="create-azure-blob-storage"><a class="header-anchor" href="#create-azure-blob-storage"></a>Create Azure Blob Storage</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">az storage account create --sku Standard_LRS --resource-group [your resource group] --location eastus --name [enter storage name here]</div></pre></td></tr></table></figure>
<p>You will see the storage account meta data outputted to the screen.</p>
<h2 id="azure-stream-analytics"><a class="header-anchor" href="#azure-stream-analytics"></a>Azure Stream Analytics</h2>
<h3 id="create-azure-stream-analytics-job"><a class="header-anchor" href="#create-azure-stream-analytics-job"></a>Create Azure Stream Analytics Job</h3>
<p>Go to the Azure Portal and create a new Azure Steam Analytics job:<br>
<img src="000180.png" alt=""></p>
<h3 id="wire-up-iot-hub-input"><a class="header-anchor" href="#wire-up-iot-hub-input"></a>Wire Up IoT Hub Input</h3>
<p>1. Go to the ASA job you just created and click on Inputs.<br>
<img src="000181.png" alt=""></p>
<p>Something to be aware of, ASA does not allow you to test the input with a physical Avro container file, like it does with JSON/CSV. The only way to test Avro is to send the message to the ASA Input and view the logs if you have issues. The logs are not that helpful as all it says is the file is invalid.</p>
<p>2. Click Add and create a new Input</p>
<p><img src="000182.png" alt=""></p>
<p>There are two bugs in the Azure Portal on this screen:</p>
<ul>
<li>You can‚Äôt select Avro using your mouse. You must use your keyboard arrows in the ‚ÄúEvent Serialization Format‚Äù dropdown.</li>
<li>You can‚Äôt use $Default consumer group. Use the consumer group you created earlier, I called mine avrocg.</li>
</ul>
<h3 id="wire-up-blob-storage-output"><a class="header-anchor" href="#wire-up-blob-storage-output"></a>Wire Up Blob Storage Output</h3>
<p>3. Click on Outputs, click Add and create a new Input</p>
<p><img src="000183.png" alt=""></p>
<ul>
<li>Select the Blob Storage Account you created earlier</li>
<li>Select Create a new container and name it <code>avros</code>.</li>
</ul>
<h3 id="write-asa-query"><a class="header-anchor" href="#write-asa-query"></a>Write ASA Query</h3>
<p>4. Click on Query, then enter the following query into the query text box.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">SELECT</div><div class="line">    *</div><div class="line">INTO</div><div class="line">    avrooutput</div><div class="line">FROM</div><div class="line">    avroinput</div></pre></td></tr></table></figure>
<p><img src="000184.png" alt=""></p>
<p>This query is intentionally simple because this post is about wiring everything up and not sophisticated ASA queries.</p>
<p>5. Click Save</p>
<h3 id="start-asa-job"><a class="header-anchor" href="#start-asa-job"></a>Start ASA Job</h3>
<p>Click ‚ÄòOverview‚Äô, then click Start</p>
<p><img src="000185.png" alt=""></p>
<p>Once the ASA job is started, you will see the following monitoring visual in the Azure Portal.</p>
<p><img src="000186.png" alt=""></p>
<p>If you have any issues, please refer to the Activity log tab to see if any messages are being logged.</p>
<h2 id="view-blob-storage-messages"><a class="header-anchor" href="#view-blob-storage-messages"></a>View Blob Storage Messages</h2>
<p>We‚Äôll now use the <a href="http://storageexplorer.com/" target="_blank" rel="external">Azure Storage Explorer</a> to inspect the JSON messages that have been stored in Blob Storage.</p>
<p>1. Open Azure Storage Explorer, sign-in and navigate to the Blob Storage account you created earlier. Expand the Blob Containers node. Click on ‚Äòavros‚Äô and you will see a JSON file in the right pane.</p>
<p><img src="000187.png" alt=""></p>
<p>2. Double-click on that file to download it. Open it and you will see the JSON messages.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"deviceId"</span>: <span class="string">"device1"</span>,</div><div class="line">    <span class="string">"windSpeed"</span>: <span class="number">11.22899055480957</span>,</div><div class="line">    <span class="string">"EventProcessedUtcTime"</span>: <span class="string">"2017-05-05T05:52:52.0236378Z"</span>,</div><div class="line">    <span class="string">"PartitionId"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"EventEnqueuedUtcTime"</span>: <span class="string">"2017-05-05T05:51:52.7660000Z"</span>,</div><div class="line">    <span class="string">"IoTHub"</span>: &#123;</div><div class="line">        <span class="string">"MessageId"</span>: <span class="literal">null</span>,</div><div class="line">        <span class="string">"CorrelationId"</span>: <span class="literal">null</span>,</div><div class="line">        <span class="string">"ConnectionDeviceId"</span>: <span class="string">"avro-device"</span>,</div><div class="line">        <span class="string">"ConnectionDeviceGenerationId"</span>: <span class="string">"636295329478829335"</span>,</div><div class="line">        <span class="string">"EnqueuedTime"</span>: <span class="string">"2017-05-05T05:51:53.2330000Z"</span>,</div><div class="line">        <span class="string">"StreamId"</span>: <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="conclusion"><a class="header-anchor" href="#conclusion"></a>Conclusion</h2>
<p>We now have all of the services setup and running that enable Avro compression in an Azure IoT solution.</p>
<p>1. <strong>Avro Node.js Script</strong> is sending messages to IoT Hub</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Sending message: Obj‚ïî‚ïùavro.schemaÔøΩ‚ïî&#123;<span class="string">"name"</span>:<span class="string">"telemetry"</span>,<span class="string">"type"</span>:<span class="string">"record"</span>,<span class="string">"fields"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"deviceId"</span>,<span class="string">"type"</span>:<span class="string">"string"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"windSpeed"</span>,<span class="string">"type"</span>:<span class="string">"float"</span>&#125;]&#125;avro.codecdeflate x‚ïëÔøΩÔøΩÔøΩN;:i&gt;&amp;ÔøΩNÔøΩÔøΩ‚ïóÔøΩKI-ÔøΩLN5&lt;r</div><div class="line">0ÔøΩ x‚ïëÔøΩÔøΩÔøΩN;:i&gt;&amp;ÔøΩNÔøΩÔøΩ</div><div class="line">send status: MessageEnqueued</div></pre></td></tr></table></figure>
<p>2. <strong>IoT Hub</strong> is receiving messages.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">==== From: avro-device ====</div><div class="line">Objavro.schemaÔøΩ&#123;<span class="string">"name"</span>:<span class="string">"telemetry"</span>,<span class="string">"type"</span>:<span class="string">"record"</span>,<span class="string">"fields"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"deviceId"</span>,<span class="string">"type"</span>:<span class="string">"string"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"windSpeed"</span>,<span class="string">"type"</span>:<span class="string">"float"</span>&#125;]&#125;avro.codecdeflate u+qÔøΩÔøΩ?ÔøΩBwÔøΩFÔøΩ_ÔøΩKI-ÔøΩLN5lyÔøΩ u+qÔøΩÔøΩ?ÔøΩBwÔøΩFÔøΩ_</div><div class="line">====================</div></pre></td></tr></table></figure>
<p>3. <strong>Azure Stream Analytics</strong> is picking up messages from IoT Hub and saving them as JSON to Blob Storage</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"deviceId"</span>: <span class="string">"device1"</span>,</div><div class="line">    <span class="string">"windSpeed"</span>: <span class="number">11.22899055480957</span>,</div><div class="line">    <span class="string">"EventProcessedUtcTime"</span>: <span class="string">"2017-05-05T05:52:52.0236378Z"</span>,</div><div class="line">    <span class="string">"PartitionId"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"EventEnqueuedUtcTime"</span>: <span class="string">"2017-05-05T05:51:52.7660000Z"</span>,</div><div class="line">    <span class="string">"IoTHub"</span>: &#123;</div><div class="line">        <span class="string">"MessageId"</span>: <span class="literal">null</span>,</div><div class="line">        <span class="string">"CorrelationId"</span>: <span class="literal">null</span>,</div><div class="line">        <span class="string">"ConnectionDeviceId"</span>: <span class="string">"avro-device"</span>,</div><div class="line">        <span class="string">"ConnectionDeviceGenerationId"</span>: <span class="string">"636295329478829335"</span>,</div><div class="line">        <span class="string">"EnqueuedTime"</span>: <span class="string">"2017-05-05T05:51:53.2330000Z"</span>,</div><div class="line">        <span class="string">"StreamId"</span>: <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Hope this helps you out.</p>
<p>Jon</p>

        </div>
        <footer>
        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                            
                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar">
        <i class="toggle icon"></i>
    </a>
    <div class="sidebar-top">

        <ul class="social-links">
            
            
            <li>
                <a class="social-tooltip" title="twitter" href="http://twitter.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-twitter"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="github" href="https://github.com/jongio"
                    target="_blank">
                    <i class="icon fa fa-github"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="rss" href="http://feeds.feedburner.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-rss"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="linkedin" href="http://www.linkedin.com/in/jongallant"
                    target="_blank">
                    <i class="icon fa fa-linkedin"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="youtube" href="https://www.youtube.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-youtube"></i>
                </a>
            </li>
            
            
        </ul>
    </div>
    
    
    <nav id="article-nav">
        
            <a href="/2017/05/azure-iot-endpoint-unreachable/" id="article-nav-newer" class="article-nav-link-wrap">
                <strong class="article-nav-caption">
                    newer
                </strong>
                <p class="article-nav-title">
                    
                        Solution to Unreachable Azure IoT Hub Endpoint
                            
                </p>
                <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>

            </a>
            
                
                    <a href="/2017/04/postman-newman-vsts-continuous-integration/" id="article-nav-older" class="article-nav-link-wrap">
                        <strong class="article-nav-caption">
                            older
                        </strong>
                        <p class="article-nav-title">
                            How to Execute Postman Collections in your Continuous Integration Pipeline with Visual Studio Team Services (VSTS) and newman
                        </p>
                        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>

                    </a>
                    
    </nav>
    
    

    <div class="widgets-container">
        
        
        <br/>
<div style="position:relative;height:0;padding-bottom:56.25%"><iframe src="https://www.youtube.com/embed/videoseries?list=PLiMIJTv6gK5_Zmdcmbo-kxAbpeGjSou9x&amp;showinfo=0?ecver=2" width="640" height="360" frameborder="0" gesture="media" allow="encrypted-media" style="position:absolute;width:100%;height:100%;left:0" allowfullscreen></iframe></div>
<br/>
        
        <div class="github-card" data-github="jongio" data-width="340" data-height="150" data-theme="default"></div>
<script src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
        
        <a class="twitter-timeline" data-height="700" href="https://twitter.com/jongallant?ref_src=twsrc%5Etfw"></a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        
        

        <div class="rail-ad">
            <!-- rail -->
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7253926757222509" data-ad-slot="7222147978"
                data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </div>
</aside>
                </div>
            </div>
        </div>
        <div class="banner-ad">
    <!-- banner -->
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7253926757222509" data-ad-slot="8838481977"
        data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo-n"></a>
                </h1>
                <p>&copy;
                    2019
                    Jon Gallant
                </p>
                <p>Disclaimer: The opinions expressed herein are my own personal opinions and do not represent my
                    employer‚Äôs view in any way.</p>
            </div>

        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'jongallant';
    
    
    var disqus_url = 'https://blog.jongallant.com/2017/05/azure-iot-stream-analytics-avro-nodejs/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>

</html>