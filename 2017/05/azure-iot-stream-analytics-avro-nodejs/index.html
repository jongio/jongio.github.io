<!DOCTYPE html>
<html>

<head>
    <script data-ad-client="ca-pub-7253926757222509" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FP3DVRSXN0"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FP3DVRSXN0');
    </script>
    <meta charset="utf-8">
    
    <title>
        
        How to use Apache Avro Compression with Azure IoT, Azure Stream Analytics, and Node.js |
        
        Jon Gallant
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="azure,iot,avro,asa" />
    
    <meta name="description" content="I was recently working with a customer that uses Apache Avro compression and discovered that there isn’t a great example out there that shows you how to send Avro compressed messages through the IoT p">
<meta property="og:type" content="article">
<meta property="og:title" content="How to use Apache Avro Compression with Azure IoT, Azure Stream Analytics, and Node.js">
<meta property="og:url" content="https://blog.jongallant.com/2017/05/azure-iot-stream-analytics-avro-nodejs/index.html">
<meta property="og:site_name" content="Jon Gallant">
<meta property="og:description" content="I was recently working with a customer that uses Apache Avro compression and discovered that there isn’t a great example out there that shows you how to send Avro compressed messages through the IoT p">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.jongallant.com/2017/05/azure-iot-stream-analytics-avro-nodejs/000188.png">
<meta property="article:published_time" content="2017-05-03T21:32:50.000Z">
<meta property="article:modified_time" content="2018-12-11T02:49:05.000Z">
<meta property="article:author" content="Jon Gallant">
<meta property="article:tag" content="azure">
<meta property="article:tag" content="iot">
<meta property="article:tag" content="avro">
<meta property="article:tag" content="asa">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.jongallant.com/2017/05/azure-iot-stream-analytics-avro-nodejs/000188.png">
<meta name="twitter:creator" content="@jongallant">
    

    
    <link rel="alternate" href="http://feeds.feedburner.com/jongallant" title="Jon Gallant"
        type="application/atom+xml" />
    

    
    <link rel="icon" href="/favicon.ico" />
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/titillium-web/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    
<link rel="stylesheet" href="/libs/jquery-ui/1.12.1/jquery-ui.min.css">


    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="//fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    
<link rel="stylesheet" href="/css/style.css">


    
<script src="/libs/jquery/2.0.3/jquery.min.js"></script>

    
<script src="/libs/jquery-ui/1.12.1/jquery-ui.min.js"></script>


    
    
        <script type="text/javascript">
    (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-1148981-8', 'auto');
    ga('send', 'pageview');

</script>
    

<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-vsc-dark-plus.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>
    <div id="wrap">
        <header id="header">
  <div id="header-outer" class="outer">
    <div class="container">
      <div class="container-inner">
        <div id="header-title">
          <h1 class="logo-wrap">
            <a href="/" class="logo"></a>
          </h1>
          
        </div>
        <div id="header-inner" class="nav-container">
          <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
          <div class="nav-container-inner">
            <ul id="main-nav">
              
              <li class="main-nav-list-item">
                <a
                  class="main-nav-list-link"
                  href="/"
                  >Home</a
                >
              </li>
               <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/">Leadership</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Career-Model/">Career Model</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Proactive-Mentorship/">Proactive Mentorship</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Productivity/">Productivity</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Review-Model/">Review Model</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Work-Life-Balance/">Work:Life Balance</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Puzzles/">Puzzles</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Reviews/">Reviews</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/">Tech</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/3D-Printing/">3D Printing</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Announcements/">Announcements</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Azure/">Azure</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Bugs/">Bugs</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Career/">Career</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Conferences/">Conferences</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Gaming/">Gaming</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/IoT/">IoT</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Jobs/">Jobs</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Microsoft/">Microsoft</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Power-BI/">Power BI</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Reviews/">Reviews</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Story/">Story</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Tips/">Tips</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Tutorials/">Tutorials</a></li></ul></li></ul> 
              <li class="main-nav-list-item">
                <a
                  class="main-nav-list-link"
                  href="/archives/"
                  >Archive</a
                >
              </li>
              
              <li class="main-nav-list-item">
                <a
                  class="main-nav-list-link"
                  href="/videos/"
                  >Videos</a
                >
              </li>
              
              <li class="main-nav-list-item">
                <a
                  class="main-nav-list-link"
                  href="/contact/"
                  >Contact</a
                >
              </li>
              
            </ul>
            <nav id="sub-nav">
                <script async src="https://cse.google.com/cse.js?cx=partner-pub-7253926757222509:9158994875"></script>
                <div class="gcse-searchbox-only"></div>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/category/Tech/">Tech</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/category/Tech/Azure/">Azure</a>
    </h1>
</div>

                        
                        <div class="main-body-content">
                            <div class="banner-ad">
                                <!-- banner -->
                                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7253926757222509"
                                    data-ad-slot="8838481977" data-ad-format="auto" data-full-width-responsive="true"></ins>
                                <script>
                                    (adsbygoogle = window.adsbygoogle || []).push({});
                                </script>
                            </div>
                            <article id="post-azure-iot-stream-analytics-avro-nodejs" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        How to use Apache Avro Compression with Azure IoT, Azure Stream Analytics, and Node.js
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                
<a href="/2017/05/azure-iot-stream-analytics-avro-nodejs/" class="article-date">
    <time datetime="2017-05-03T21:32:50.000Z" itemprop="datePublished">2017-05-03</time>
</a>

                
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asa/" rel="tag">asa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/avro/" rel="tag">avro</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/azure/" rel="tag">azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iot/" rel="tag">iot</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>I was recently working with a customer that uses <a href="https://avro.apache.org/" target="_blank" rel="noopener">Apache Avro</a> compression and discovered that there isn’t a great example out there that shows you how to send Avro compressed messages through the IoT pipeline. This post will hopefully fill that gap.</p>
<p>Compression is a very common need in IoT scenarios because most large scale IoT solutions include message aggregation and compression before sending the messages across the wire.  IoT Hub itself “supports compression” because it doesn’t crack the message payload - it just treats the message as bytes across the wire. So, the cloud endpoint (IoT Hub) isn’t an issue. The issue arises when we need to use compression and then process those messages post-ingestion. Azure Stream Analytics, a common Azure IoT message ingestor, supports JSON, CSV and Avro.  Gzip/Deflate are not supported, but the request has been made into the ASA team to support them. In the meantime, this post will demonstrate how to get Avro to work through the IoT pipeline and unblock those customers that want compression and are considering Avro. If you need to support Gzip/Deflate or any other compression mechanism, then you will need to process your IoT Hub messages via the backing Event Hub using Event Processor Host via Azure Functions, Service Fabric or any custom application.</p>
<p>The architecture for this walkthrough is as follows:</p>
<p>A <strong>Node.js</strong> script reads telemetry data from sensors, compresses that data with <strong>Avro</strong> and then sends to <strong>IoT Hub</strong>. An <strong>Azure Stream Analytics (ASA)</strong> job picks up those messages and forwards them to <strong>Azure Blob Storage</strong> as JSON objects.</p>
<p>You can follow along to build this entire example from scratch or you can click <a href="#Run-Avro-Script">here</a>, if you just want to jump to the Avro code.</p>
<h2 id="Tools"><a class="header-anchor" href="#Tools"></a>Tools</h2>
<h3 id="Azure-CLI-2-0"><a class="header-anchor" href="#Azure-CLI-2-0"></a>Azure CLI 2.0</h3>
<p>You have three options for creating the Azure resources required for this example. <strong>I will use Azure CLI 2.0 in this post.</strong></p>
<p>1. <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" target="_blank" rel="noopener">Azure CLI 2.0</a><br>
2. <a href="https://docs.microsoft.com/en-us/azure/cli-install-nodejs" target="_blank" rel="noopener">Azure CLI 1.0</a><br>
3. <a href="https://portal.azure.com" target="_blank" rel="noopener">Azure Portal</a></p>
<p>Follow the steps <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" target="_blank" rel="noopener">here to install Azure CLI 2.0</a>.</p>
<h3 id="iothub-explorer"><a class="header-anchor" href="#iothub-explorer"></a>iothub-explorer</h3>
<p>We will use the iothub-explorer to monitor messages that are sent to IoT Hub.</p>
<p>Follow the steps <a href="https://github.com/Azure/iothub-explorer" target="_blank" rel="noopener">here to install the iothub-explorer</a>.</p>
<p>You could also use the Windows Form version called the <a href="https://github.com/Azure/azure-iot-sdk-csharp/tree/master/tools/DeviceExplorer#download" target="_blank" rel="noopener">Device Explorer</a>.</p>
<h3 id="Azure-Storage-Explorer"><a class="header-anchor" href="#Azure-Storage-Explorer"></a>Azure Storage Explorer</h3>
<p>We will use Azure Storage Explorer to view the outputted messages that are sent to Blob storage from the ASA job.</p>
<p>Follow the steps <a href="http://storageexplorer.com/" target="_blank" rel="noopener">here to install the Azure Storage Explorer</a>.</p>
<h2 id="IoT-Hub"><a class="header-anchor" href="#IoT-Hub"></a>IoT Hub</h2>
<h3 id="Create-IoT-Hub"><a class="header-anchor" href="#Create-IoT-Hub"></a>Create IoT Hub</h3>
<p>Follow the steps <a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-create-using-cli" target="_blank" rel="noopener">here to create an Azure IoT Hub using the Azure CLI 2.0</a>.</p>
<h3 id="Get-IoT-Hub-Connection-String"><a class="header-anchor" href="#Get-IoT-Hub-Connection-String"></a>Get IoT Hub Connection String</h3>
<p>Execute the following command to get the connection string for the IoT Hub you just created.</p>
<pre class="line-numbers language-bash"><code class="language-bash">az iot hub show-connection-string --hub-name [your IoT Hub name]
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Copy that connection string to a safe place. You will need it later.</p>
<h3 id="Create-IoT-Hub-Device"><a class="header-anchor" href="#Create-IoT-Hub-Device"></a>Create IoT Hub Device</h3>
<p>Execute the following command to create a new IoT Hub device.</p>
<pre class="line-numbers language-bash"><code class="language-bash">az iot device create --hub-name [your IoT Hub name] --device-id [your IoT Hub device name]
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Get-Device-Connection-String"><a class="header-anchor" href="#Get-Device-Connection-String"></a>Get Device Connection String</h3>
<pre class="line-numbers language-bash"><code class="language-bash">az iot device show-connection-string --hub-name [your IoT Hub name] --device-id [your IoT Hub device name]
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Copy that device’s connection string to a safe place. You will need it later.</p>
<h3 id="Create-IoT-Hub-Consumer-Group"><a class="header-anchor" href="#Create-IoT-Hub-Consumer-Group"></a>Create IoT Hub Consumer Group</h3>
<p>You will need a new IoT Hub consumer group when you configure ASA later.  Let’s create it now with the following command:</p>
<pre class="line-numbers language-bash"><code class="language-bash">az iot hub consumer-group create --hub-name [your IoT Hub name] --name avrocg
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Start-Monitoring-Events"><a class="header-anchor" href="#Start-Monitoring-Events"></a>Start Monitoring Events</h2>
<p>Execute the following command to monitor events for the device you just created:</p>
<pre class="line-numbers language-bash"><code class="language-bash">iothub-explorer monitor-events [your IoT Hub device name] --login "[your IoT Hub connection string goes here]"
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>You will see the following output:</p>
<pre class="line-numbers language-bash"><code class="language-bash">Monitoring events from device avro-device...
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Keep that command open, we’ll come back to it in a minute.</p>
<h2 id="Run-Avro-Script"><a class="header-anchor" href="#Run-Avro-Script"></a>Run Avro Script</h2>
<p>We will now get the Node.js code that will compress messages with Avro and send them to IoT Hub.</p>
<p>Let’s get it running and then go through code.</p>
<h3 id="Install-Node-js-and-git"><a class="header-anchor" href="#Install-Node-js-and-git"></a>Install Node.js and git</h3>
<p>Make sure you have <a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">Node.js</a> and <a href="https://git-scm.com/downloads" target="_blank" rel="noopener">git</a> installed.</p>
<h3 id="Clone-Repo"><a class="header-anchor" href="#Clone-Repo"></a>Clone Repo</h3>
<p>Open up a command prompt, navigate to an empty folder and execute the following command.  This will copy the code to a local folder.</p>
<pre class="line-numbers language-bash"><code class="language-bash">git clone https://github.com/jongio/azure-iot-stream-analytics-avro-nodejs.git
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Install-Node-js-Packages"><a class="header-anchor" href="#Install-Node-js-Packages"></a>Install Node.js Packages</h3>
<p>Change to the directory that contains the code you just cloned and execute the following command to get the Node.js packages locally.</p>
<pre class="line-numbers language-bash"><code class="language-bash">npm i
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Setup-Config"><a class="header-anchor" href="#Setup-Config"></a>Setup Config</h3>
<p>This script uses <a href="https://www.npmjs.com/package/dotenv" target="_blank" rel="noopener">dotenv</a> to allow you to set an IoT Hub connection string in a .env file.</p>
<p>Rename “.env.sample” to “.env” and paste your <strong>device</strong> connection string that you saved earlier. If you are using Windows, then name the file .env. (with the . at the end) and Windows will automatically change it to .env for you.</p>
<pre class="line-numbers language-bash"><code class="language-bash">iotHubConnectionString=[your device's connection string goes here]
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Run-Script"><a class="header-anchor" href="#Run-Script"></a>Run Script</h3>
<p>Execute the following to start sending messages to IoT Hub.</p>
<pre class="line-numbers language-bash"><code class="language-bash">node index.js
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>You will now see the following output:</p>
<pre class="line-numbers language-bash"><code class="language-bash">Connected to IoT Hub
Sending message: Obj╔╝avro.schema�╔{"name":"telemetry","type":"record","fields":[{"name":"deviceId","type":"string"},{"name":"windSpeed","type":"float"}]}avro.codecdeflate }4똑�%��
                                                                                                                                                                                    ��E��x╗�KI-�LN5��
}4똑�%��
        ��E��x
send status: MessageEnqueued
Sending message: Obj╔╝avro.schema�╔{"name":"telemetry","type":"record","fields":[{"name":"deviceId","type":"string"},{"name":"windSpeed","type":"float"}]}avro.codecdeflate �7�zXNObQU}��╗�KI-�LN5�=�
�7�zXNObQU}��
send status: MessageEnqueued
Sending message: Obj╔╝avro.schema�╔{"name":"telemetry","type":"record","fields":[{"name":"deviceId","type":"string"},{"name":"windSpeed","type":"float"}]}avro.codecdeflate ��b�zj����[���╗�KI-�LN5
                                                                                                                                                                                                   �

p╝ ��b�zj����[���
send status: MessageEnqueued
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Monitor-Messages-Coming-into-IoT-Hub"><a class="header-anchor" href="#Monitor-Messages-Coming-into-IoT-Hub"></a>Monitor Messages Coming into IoT Hub</h3>
<p>Switch back to the command prompt with iothub-explorer open and you will now start to see events outputted:</p>
<pre class="line-numbers language-bash"><code class="language-bash">==== From: avro ====
Objavro.schema�{"name":"telemetry","type":"record","fields":[{"name":"deviceId","type":"string"},{"name":"windSpeed","type":"float"}]}avro.codecdeflate K=�8h{�!���ng�q�KI-�LN5��1r K=�8h{�!���ng�q
====================
==== From: avro ====
Objavro.schema�{"name":"telemetry","type":"record","fields":[{"name":"deviceId","type":"string"},{"name":"windSpeed","type":"float"}]}avro.codecdeflate ӣ ��މ�]#��T���KI-�LN5\��� ӣ ��މ�]#��T��
====================
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Inspect-Avro-Script"><a class="header-anchor" href="#Inspect-Avro-Script"></a>Inspect Avro Script</h2>
<p>Now that we have it running, let’s take a look at the script to see how it works.</p>
<p>You can see the full code on GitHub <a href="https://github.com/jongio/azure-iot-stream-analytics-avro-nodejs/blob/master/index.js" target="_blank" rel="noopener">here</a>. There are lots of comments inline that should help you see how it all works together.</p>
<p>The script uses following npm packages: <a href="https://www.npmjs.com/package/avsc" target="_blank" rel="noopener">avsc</a>, <a href="https://www.npmjs.com/package/memory-streams" target="_blank" rel="noopener">memory-streams</a>, <a href="https://www.npmjs.com/package/azure-iot-device" target="_blank" rel="noopener">azure-iot-device</a> and <a href="https://www.npmjs.com/package/azure-iot-device-amqp" target="_blank" rel="noopener">azure-iot-device-amqp</a>.</p>
<p>With Avro, you can embed the payload schema into the Avro Container file.  In this repo, we have a file called <code>schema.avsc</code>, which looks like this:</p>
<pre class="line-numbers language-json"><code class="language-json">{
    "name": "telemetry",
    "type": "record",
    "fields": [
        { "name": "deviceId", "type": "string" },
        { "name": "windSpeed", "type": "float" }
    ]
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>In fact, ASA requires the schema to be embedded into the message payload.</p>
<p>This file Avro type is loaded via the parse method like this:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">const type = avro.parse(__dirname + '/schema.avsc');
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>At the moment, ASA does not support ENUMs in your Avro schema. Convert the ENUM to string if you are having issues.  I will update this post when that has been resolved.</p>
<p>The meat of the code is as follows:</p>
<ul>
<li>Instantiate a BlockEncoder with deflate codec</li>
<li>Instantiate a WriteableStream and pipe BlockEncoder writes to it.</li>
<li>Write to the BlockEncoder</li>
<li>Call BlockEncoder.end();</li>
<li>Send IoT Hub message in the ‘end’ event handler, which calls WriateableStream.toBuffer()</li>
</ul>
<pre class="line-numbers language-javascript"><code class="language-javascript">// Instantiate a BlockEncoder, which allows you to write avro into a buffer.
var avroEncoder = new avro.streams.BlockEncoder(type, { codec: 'deflate' }); // Choose 'deflate' or it will default to 'null'

// Instantiate a stream to write the avro buffer to, which we'll send to IoT Hub
var writer = new streams.WritableStream();
avroEncoder.pipe(writer);

// Generate the faux json
var windSpeed = 10 + (Math.random() * 4); // range: [10, 14]
var json = { deviceId: 'device1', windSpeed: windSpeed };

// Write the json
if (type.isValid(json)) {
    avroEncoder.write(json);
}

// Call end to tell avro we are done writing and to trigger the end event.
avroEncoder.end();

// end event was triggered, get the avro data from the piped stream and send to IoT Hub.
avroEncoder.on('end', function () {
    // call toBuffer on the WriteableStream and pass to IoT Hub message ctor
    var message = new Message(writer.toBuffer());

    console.log('Sending message: ' + message.getData());
    client.sendEvent(message, printResultFor('send'));
})
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>While this seems like a pretty straight forward script, it took me a while to get it all working.  In the process, I collected the following Avro related resources:</p>
<ul>
<li><a href="https://github.com/mtth/avsc/" target="_blank" rel="noopener">Avro Node.js Library: mtth/avsc</a></li>
<li><a href="http://www.michael-noll.com/blog/2013/03/17/reading-and-writing-avro-files-from-the-command-line/" target="_blank" rel="noopener">Reading and Writing Avro Files From the Command Line</a></li>
<li><a href="https://nodejs.org/api/stream.html" target="_blank" rel="noopener">Node.js Stream Docs</a></li>
<li><a href="http://codewinds.com/blog/2013-08-31-nodejs-duplex-streams.html" target="_blank" rel="noopener">Creating duplex streams with Node.js</a></li>
<li><a href="https://stackoverflow.com/questions/39045356/how-to-send-compacted-data-to-azure-stream-analytics" target="_blank" rel="noopener">How to send compacted data to Azure Stream Analytics?</a></li>
<li><a href="https://blogs.msdn.microsoft.com/streamanalytics/2015/10/28/sending-and-consuming-events-in-avro-format/" target="_blank" rel="noopener">Sending and consuming events in Avro format</a></li>
<li><a href="https://github.com/mtth/avsc/issues/75" target="_blank" rel="noopener">Rotate stream into google cloud storage #75</a></li>
<li><a href="https://github.com/mtth/avsc/issues/17" target="_blank" rel="noopener">BlockEncoder produces invalid avro format? #17</a></li>
<li><a href="https://github.com/miguno/avro-cli-examples" target="_blank" rel="noopener">avro-cli-examples</a></li>
</ul>
<h2 id="Azure-Blob-Storage"><a class="header-anchor" href="#Azure-Blob-Storage"></a>Azure Blob Storage</h2>
<p>For this contrived exercise, we’re going to configure a Blob Storage account that ASA sends all messages to.  Let’s create the account and then wire up ASA.</p>
<h2 id="Create-Azure-Blob-Storage"><a class="header-anchor" href="#Create-Azure-Blob-Storage"></a>Create Azure Blob Storage</h2>
<pre class="line-numbers language-bash"><code class="language-bash">az storage account create --sku Standard_LRS --resource-group [your resource group] --location eastus --name [enter storage name here]
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>You will see the storage account meta data outputted to the screen.</p>
<h2 id="Azure-Stream-Analytics"><a class="header-anchor" href="#Azure-Stream-Analytics"></a>Azure Stream Analytics</h2>
<h3 id="Create-Azure-Stream-Analytics-Job"><a class="header-anchor" href="#Create-Azure-Stream-Analytics-Job"></a>Create Azure Stream Analytics Job</h3>
<p>Go to the Azure Portal and create a new Azure Steam Analytics job:<br>
<img src="000180.png" alt=""></p>
<h3 id="Wire-Up-IoT-Hub-Input"><a class="header-anchor" href="#Wire-Up-IoT-Hub-Input"></a>Wire Up IoT Hub Input</h3>
<p>1. Go to the ASA job you just created and click on Inputs.<br>
<img src="000181.png" alt=""></p>
<p>Something to be aware of, ASA does not allow you to test the input with a physical Avro container file, like it does with JSON/CSV. The only way to test Avro is to send the message to the ASA Input and view the logs if you have issues. The logs are not that helpful as all it says is the file is invalid.</p>
<p>2. Click Add and create a new Input</p>
<p><img src="000182.png" alt=""></p>
<p>There are two bugs in the Azure Portal on this screen:</p>
<ul>
<li>You can’t select Avro using your mouse. You must use your keyboard arrows in the “Event Serialization Format” dropdown.</li>
<li>You can’t use $Default consumer group. Use the consumer group you created earlier, I called mine avrocg.</li>
</ul>
<h3 id="Wire-Up-Blob-Storage-Output"><a class="header-anchor" href="#Wire-Up-Blob-Storage-Output"></a>Wire Up Blob Storage Output</h3>
<p>3. Click on Outputs, click Add and create a new Input</p>
<p><img src="000183.png" alt=""></p>
<ul>
<li>Select the Blob Storage Account you created earlier</li>
<li>Select Create a new container and name it <code>avros</code>.</li>
</ul>
<h3 id="Write-ASA-Query"><a class="header-anchor" href="#Write-ASA-Query"></a>Write ASA Query</h3>
<p>4. Click on Query, then enter the following query into the query text box.</p>
<pre class="line-numbers language-bash"><code class="language-bash">SELECT
    *
INTO
    avrooutput
FROM
    avroinput
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="000184.png" alt=""></p>
<p>This query is intentionally simple because this post is about wiring everything up and not sophisticated ASA queries.</p>
<p>5. Click Save</p>
<h3 id="Start-ASA-Job"><a class="header-anchor" href="#Start-ASA-Job"></a>Start ASA Job</h3>
<p>Click ‘Overview’, then click Start</p>
<p><img src="000185.png" alt=""></p>
<p>Once the ASA job is started, you will see the following monitoring visual in the Azure Portal.</p>
<p><img src="000186.png" alt=""></p>
<p>If you have any issues, please refer to the Activity log tab to see if any messages are being logged.</p>
<h2 id="View-Blob-Storage-Messages"><a class="header-anchor" href="#View-Blob-Storage-Messages"></a>View Blob Storage Messages</h2>
<p>We’ll now use the <a href="http://storageexplorer.com/" target="_blank" rel="noopener">Azure Storage Explorer</a> to inspect the JSON messages that have been stored in Blob Storage.</p>
<p>1. Open Azure Storage Explorer, sign-in and navigate to the Blob Storage account you created earlier. Expand the Blob Containers node. Click on ‘avros’ and you will see a JSON file in the right pane.</p>
<p><img src="000187.png" alt=""></p>
<p>2. Double-click on that file to download it. Open it and you will see the JSON messages.</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">{
    "deviceId": "device1",
    "windSpeed": 11.22899055480957,
    "EventProcessedUtcTime": "2017-05-05T05:52:52.0236378Z",
    "PartitionId": 0,
    "EventEnqueuedUtcTime": "2017-05-05T05:51:52.7660000Z",
    "IoTHub": {
        "MessageId": null,
        "CorrelationId": null,
        "ConnectionDeviceId": "avro-device",
        "ConnectionDeviceGenerationId": "636295329478829335",
        "EnqueuedTime": "2017-05-05T05:51:53.2330000Z",
        "StreamId": null
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Conclusion"><a class="header-anchor" href="#Conclusion"></a>Conclusion</h2>
<p>We now have all of the services setup and running that enable Avro compression in an Azure IoT solution.</p>
<p>1. <strong>Avro Node.js Script</strong> is sending messages to IoT Hub</p>
<pre class="line-numbers language-bash"><code class="language-bash">Sending message: Obj╔╝avro.schema�╔{"name":"telemetry","type":"record","fields":[{"name":"deviceId","type":"string"},{"name":"windSpeed","type":"float"}]}avro.codecdeflate x║���N;:i&gt;&amp;�N��╗�KI-�LN5&lt;r
0� x║���N;:i&gt;&amp;�N��
send status: MessageEnqueued
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>2. <strong>IoT Hub</strong> is receiving messages.</p>
<pre class="line-numbers language-bash"><code class="language-bash">==== From: avro-device ====
Objavro.schema�{"name":"telemetry","type":"record","fields":[{"name":"deviceId","type":"string"},{"name":"windSpeed","type":"float"}]}avro.codecdeflate u+q��?�Bw�F�_�KI-�LN5ly� u+q��?�Bw�F�_
====================
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>3. <strong>Azure Stream Analytics</strong> is picking up messages from IoT Hub and saving them as JSON to Blob Storage</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">{
    "deviceId": "device1",
    "windSpeed": 11.22899055480957,
    "EventProcessedUtcTime": "2017-05-05T05:52:52.0236378Z",
    "PartitionId": 0,
    "EventEnqueuedUtcTime": "2017-05-05T05:51:52.7660000Z",
    "IoTHub": {
        "MessageId": null,
        "CorrelationId": null,
        "ConnectionDeviceId": "avro-device",
        "ConnectionDeviceGenerationId": "636295329478829335",
        "EnqueuedTime": "2017-05-05T05:51:53.2330000Z",
        "StreamId": null
    }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Hope this helps you out.</p>
<p>Jon</p>

        </div>
        <footer>
        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar">
        <i class="toggle icon"></i>
    </a>
    <div class="sidebar-top">

        <ul class="social-links">
            
            
            <li>
                <a class="social-tooltip" title="twitter" href="http://twitter.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-twitter"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="github" href="https://github.com/jongio"
                    target="_blank">
                    <i class="icon fa fa-github"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="rss" href="http://feeds.feedburner.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-rss"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="linkedin" href="http://www.linkedin.com/in/jongallant"
                    target="_blank">
                    <i class="icon fa fa-linkedin"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="youtube" href="https://www.youtube.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-youtube"></i>
                </a>
            </li>
            
            
        </ul>
    </div>
    
    
    <nav id="article-nav">
        
            <a href="/2017/05/azure-iot-endpoint-unreachable/" id="article-nav-newer" class="article-nav-link-wrap">
                <strong class="article-nav-caption">
                    newer
                </strong>
                <p class="article-nav-title">
                    
                        Solution to Unreachable Azure IoT Hub Endpoint
                            
                </p>
                <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>

            </a>
            
                
                    <a href="/2017/04/postman-newman-vsts-continuous-integration/" id="article-nav-older" class="article-nav-link-wrap">
                        <strong class="article-nav-caption">
                            older
                        </strong>
                        <p class="article-nav-title">
                            How to Execute Postman Collections in your Continuous Integration Pipeline with Visual Studio Team Services (VSTS) and newman
                        </p>
                        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>

                    </a>
                    
    </nav>
    
    

    <div class="widgets-container">
        
        
        <br/>
<div style="position:relative;height:0;padding-bottom:56.25%"><iframe src="https://www.youtube.com/embed/videoseries?list=PLiMIJTv6gK5_Zmdcmbo-kxAbpeGjSou9x&amp;showinfo=0?ecver=2" width="640" height="360" frameborder="0" gesture="media" allow="encrypted-media" style="position:absolute;width:100%;height:100%;left:0" allowfullscreen></iframe></div>
<br/>
        
        <div class="github-card" data-github="jongio" data-width="340" data-height="150" data-theme="default"></div>
<script src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
        
        <a class="twitter-timeline" data-height="700" href="https://twitter.com/jongallant?ref_src=twsrc%5Etfw" target="_blank" rel="noopener"></a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        
        
        <div class="rail-ad">
            <!-- rail -->
            <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-7253926757222509"
            data-ad-slot="7222147978"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>

            <!-- 2nd rail -->
            <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-7253926757222509"
            data-ad-slot="1523952970"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </div>
</aside>
                </div>
            </div>
        </div>
        <div class="banner-ad">
   <!-- footer -->
    <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-7253926757222509"
    data-ad-slot="5729050190"
    data-ad-format="auto"
    data-full-width-responsive="true"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo-n"></a>
                </h1>
                <p>&copy;
                    2021
                    Jon Gallant
                </p>
                <p>Disclaimer: The opinions expressed herein are my own personal opinions and do not represent my
                    employer’s view in any way. This post may contain affiliate links. If you use these links to buy something I may earn a commission.</p>
            </div>

        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'jongallant';
    
    
    var disqus_url = 'https://blog.jongallant.com/2017/05/azure-iot-stream-analytics-avro-nodejs/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js" integrity="sha512-xR+IAyN+t9EBIOOJw5m83FTVMDsPd63IhJ3ElP4gmfUFnQlX9+eWGLp3P4t3gIjpo2Z1JzqtW/5cjgn+oru3yQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-zc7WDnCM3aom2EziyDIRAtQg1mVXLdILE09Bo+aE1xk0AM2c2cVLfSW9NrxE5tKTX44WBY0Z2HClZ05ur9vB6A==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-br8H6OngKoLht57WKRU5jz3Vr0vF+Tw4G6yhNN2F3dSDheq4JiaasROPJB1wy7PxPk7kV/+5AIbmoZLxxx7Zow==" crossorigin="anonymous"></script>
</body>

</html>