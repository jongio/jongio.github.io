<!DOCTYPE html>
<html>

<head>
    <script data-ad-client="ca-pub-7253926757222509" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FP3DVRSXN0"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FP3DVRSXN0');
    </script>
    <meta charset="utf-8">
    
    <title>
        
        How to Upload Blobs to Azure Storage from an Azure Function with Azure Managed Identities (Part 3) |
        
        Jon Gallant
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="azure,functions,identity,.net,linux,dotnet" />
    
    <meta name="description" content="In this 3 part series we are going to learn a few methods for developing an Azure Function that uploads blobs to Azure Storage using the new Azure Blob Storage and Azure Identity Client Libraries.  Co">
<meta property="og:type" content="article">
<meta property="og:title" content="How to Upload Blobs to Azure Storage from an Azure Function with Azure Managed Identities (Part 3)">
<meta property="og:url" content="https://blog.jongallant.com/2020/02/azure-functions-blob-managed-identity-part3/index.html">
<meta property="og:site_name" content="Jon Gallant">
<meta property="og:description" content="In this 3 part series we are going to learn a few methods for developing an Azure Function that uploads blobs to Azure Storage using the new Azure Blob Storage and Azure Identity Client Libraries.  Co">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.jongallant.com/2020/02/azure-functions-blob-managed-identity-part3/000067.png">
<meta property="article:published_time" content="2020-02-02T13:35:43.000Z">
<meta property="article:modified_time" content="2021-03-18T06:41:53.000Z">
<meta property="article:author" content="Jon Gallant">
<meta property="article:tag" content="azure">
<meta property="article:tag" content="functions">
<meta property="article:tag" content="identity">
<meta property="article:tag" content=".net">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="dotnet">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.jongallant.com/2020/02/azure-functions-blob-managed-identity-part3/000067.png">
<meta name="twitter:creator" content="@jongallant">
    

    
    <link rel="alternate" href="http://feeds.feedburner.com/jongallant" title="Jon Gallant"
        type="application/atom+xml" />
    

    
    <link rel="icon" href="/favicon.ico" />
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/titillium-web/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    
<link rel="stylesheet" href="/libs/jquery-ui/1.12.1/jquery-ui.min.css">


    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="//fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    
<link rel="stylesheet" href="/css/style.css">


    
<script src="/libs/jquery/2.0.3/jquery.min.js"></script>

    
<script src="/libs/jquery-ui/1.12.1/jquery-ui.min.js"></script>


    
    
        <script type="text/javascript">
    (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-1148981-8', 'auto');
    ga('send', 'pageview');

</script>
    

<meta name="generator" content="Hexo 6.0.0"><link rel="stylesheet" href="/css/prism-vsc-dark-plus.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>
    <div id="wrap">
        <header id="header">
  <div id="header-outer" class="outer">
    <div class="container">
      <div class="container-inner">
        <div id="header-title">
          <h1 class="logo-wrap">
            <a href="/" class="logo"></a>
          </h1>
          
        </div>
        <div id="header-inner" class="nav-container">
          <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
          <div class="nav-container-inner">
            <ul id="main-nav">
              
              <li class="main-nav-list-item">
                <a
                  class="main-nav-list-link"
                  href="/"
                  >Home</a
                >
              </li>
               <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/">Leadership</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Career-Model/">Career Model</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Proactive-Mentorship/">Proactive Mentorship</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Productivity/">Productivity</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Review-Model/">Review Model</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Leadership/Work-Life-Balance/">Work:Life Balance</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Puzzles/">Puzzles</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Reviews/">Reviews</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/">Tech</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/3D-Printing/">3D Printing</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Announcements/">Announcements</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Azure/">Azure</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Bugs/">Bugs</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Career/">Career</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Conferences/">Conferences</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Gaming/">Gaming</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/IoT/">IoT</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Jobs/">Jobs</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Microsoft/">Microsoft</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Power-BI/">Power BI</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Reviews/">Reviews</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Story/">Story</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Tips/">Tips</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Tech/Tutorials/">Tutorials</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/category/Travel/">Travel</a></li></ul> 
              <li class="main-nav-list-item">
                <a
                  class="main-nav-list-link"
                  href="/archives/"
                  >Archive</a
                >
              </li>
              
              <li class="main-nav-list-item">
                <a
                  class="main-nav-list-link"
                  href="/videos/"
                  >Videos</a
                >
              </li>
              
              <li class="main-nav-list-item">
                <a
                  class="main-nav-list-link"
                  href="/contact/"
                  >Contact</a
                >
              </li>
              
            </ul>
            <nav id="sub-nav">
                <script async src="https://cse.google.com/cse.js?cx=partner-pub-7253926757222509:9158994875"></script>
                <div class="gcse-searchbox-only"></div>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/category/Tech/">Tech</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/category/Tech/Tutorials/">Tutorials</a>
    </h1>
</div>

                        
                        <div class="main-body-content">
                            <div class="banner-ad">
                                <!-- banner -->
                                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7253926757222509"
                                    data-ad-slot="8838481977" data-ad-format="auto" data-full-width-responsive="true"></ins>
                                <script>
                                    (adsbygoogle = window.adsbygoogle || []).push({});
                                </script>
                            </div>
                            <article id="post-azure-functions-blob-managed-identity-part3" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        How to Upload Blobs to Azure Storage from an Azure Function with Azure Managed Identities (Part 3)
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                
<a href="/2020/02/azure-functions-blob-managed-identity-part3/" class="article-date">
    <time datetime="2020-02-02T13:35:43.000Z" itemprop="datePublished">2020-02-02</time>
</a>

                
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/net/" rel="tag">.net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/azure/" rel="tag">azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dotnet/" rel="tag">dotnet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/functions/" rel="tag">functions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/identity/" rel="tag">identity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>In this 3 part series we are going to learn a few methods for developing an Azure Function that uploads blobs to Azure Storage using the new <a target="_blank" rel="noopener" href="https://aka.ms/azsdk/releases">Azure Blob Storage and Azure Identity Client Libraries</a>.</p>
<blockquote>
<p>Code: The code for this series can be found here: <a target="_blank" rel="noopener" href="https://github.com/jongio/azure-blob-functions-managedid">https://github.com/jongio/azure-blob-functions-managedid</a></p>
</blockquote>
<p>Part 1: <a href="/azure-functions-blob-managed-identity-part1">Local Function with Storage Emulator (local function, local storage)</a><br>
Part 2: <a href="/azure-functions-blob-managed-identity-part2">Local Function with Azure Storage and Service Principal (local function, cloud storage)</a><br>
Part 3: Azure Function with Azure Storage and Managed Identity (cloud function, cloud storage)</p>
<h2 id="Azure-Function-with-Azure-Storage-and-Managed-Identity-cloud-function-cloud-storage"><a class="header-anchor" href="#Azure-Function-with-Azure-Storage-and-Managed-Identity-cloud-function-cloud-storage"></a>Azure Function with Azure Storage and Managed Identity (cloud function, cloud storage)</h2>
<p>In Parts 1, we create a local function, wrote blobs to Azurite a local storage emulator and then in Part 2 we configured it to upload blobs to Azure Storage using AzureCliCredential. In Part 3 we are going to deploy our Azure Function to Azure and use Managed Identitiesl.  A Managed Identity is a Service Principal under the hood, but Azure takes care of regular maintenance of it and enables you to deploy your app with zero code or configuration changes.  You just use <code>DefaultAzureCredential</code> in your app and it will automatically pick up the Managed Identity and use it to authenticate with other Azure services.</p>
<h3 id="Azure-Setup"><a class="header-anchor" href="#Azure-Setup"></a>Azure Setup</h3>
<ol>
<li>Create Azure Functions Storage Account</li>
</ol>
<p>Azure Functions store metadata and logs in an Azure Storage Account.  You can use the same storage account that you created earlier to upload your blobs to or you can create a new one.</p>
<p><strong>Options:</strong></p>
<p>Option 1. Use the same storage account that you created above and skip this step.</p>
<p>Option 2. Create a new storage account for Function metadata using the following command:</p>
<pre class="line-numbers language-bash"><code class="language-bash">az storage account create -n FUNCTIONS_STORAGE_ACCOUNT_NAME -g RESOURCE_GROUP_NAME --kind StorageV2 --sku Standard_LRS 
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>FUNCTIONS_STORAGE_ACCOUNT_NAME</code> This is the name of the storage account that you want to store your Azure Functions metadata in.</li>
<li><code>RESOURCE_GROUP_NAME</code> The name of the resource group that you created earlier.</li>
<li><code>--sku</code> - List of available SKUs can be found here: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/rest/api/storagerp/srp_sku_types">SKU Types</a></li>
</ul>
<ol start="2">
<li>Create App Service Plan</li>
</ol>
<p>We are going to put our Function in an App Service Plan because that enables log streaming (among other features), whereas a Consumption based Azure Function (Linux) does not - at least not yet.</p>
<pre class="line-numbers language-bash"><code class="language-bash">az appservice plan create -n APP_SERVICE_PLAN_NAME -g RESOURCE_GROUP_NAME --is-linux --sku B1
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>APP_SERVICE_PLAN_NAME</code> A name that you choose to give your app service plan.</li>
<li><code>RESOURCE_GROUP_NAME</code> The name of the resource group that you created earlier.</li>
<li><code>--is-linux</code> You can remove this parameter if you want to use Windows</li>
<li><code>--sku</code> You can also choose <code>--sku F1</code> for a free app service plan, but you are only allowed one per subscription. You can find all of the App Service Plan SKUs here: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/cli/azure/appservice/plan?view=azure-cli-latest#optional-parameters">az appservice plan create</a></li>
</ul>
<ol start="3">
<li>Create Azure Function App</li>
</ol>
<p>This is the actual Function app that we will upload our Function app project.</p>
<pre class="line-numbers language-bash"><code class="language-bash">az functionapp create -n FUNCTION_APP_NAME -g RESOURCE_GROUP_NAME --storage-account FUNCTIONS_STORAGE_ACCOUNT_NAME --plan APP_SERVICE_PLAN_NAME --runtime dotnet --os-type Linux --functions-version 3
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>FUNCTION_APP_NAME</code> A name that you choose to call your function app.</li>
<li><code>RESOURCE_GROUP_NAME</code> The same resource group name that you created earlier</li>
<li><code>FUNCTIONS_STORAGE_ACCOUNT_NAME</code> If you only created one storage account for both Azure Function metadata and blobs, then use that single account.  If you created multiple accounts, then enter the name of the one that you want your metadata stored in here.</li>
<li><code>APP_SERVICE_PLAN_NAME</code> The name of the app service plan you created earlier.</li>
<li><code>--runtime</code> We are using dotnet in this post, but you can use any of the available options. Obviously your code will need to change to reflect that option.</li>
<li><code>--os-type</code> You can choose Windows and it should work exactly the same way.</li>
<li><code>--functions-version</code> The default is 2, so we want to set to 3.</li>
</ul>
<ol start="4">
<li>Set Function App Settings</li>
</ol>
<p>As you saw above, our code depends on two environment variables:</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">var account = Environment.GetEnvironmentVariable("AZURE_STORAGE_ACCOUNT");
var container = Environment.GetEnvironmentVariable("AZURE_STORAGE_CONTAINER");
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>For local deployments, those are configured in the <code>local.settings.json</code> file.  When we deploy to Azure we’ll need those settings in the Function app.  Use the following commands to update those settings.</p>
<pre class="line-numbers language-bash"><code class="language-bash">az functionapp config appsettings set -n FUNCTION_APP_NAME -g RESOURCE_GROUP_NAME --settings "AZURE_STORAGE_ACCOUNT=BLOB_STORAGE_ACCOUNT_NAME" "AZURE_STORAGE_CONTAINER=azfuncblobs" "AZURE_STORAGE_HOST=blob.core.windows.net"
 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>FUNCTION_APP_NAME</code> A name that you choose to call your function app.</li>
<li><code>RESOURCE_GROUP_NAME</code> The same resource group name that you created earlier</li>
<li><code>BLOB_STORAGE_ACCOUNT_NAME</code> The storage account name that you would like to store the blobs in.</li>
<li><code>AZURE_STORAGE_CONTAINER</code> You can also change the name of the container.  For this post it is azfuncblobs.</li>
</ul>
<h3 id="Assign-Managed-Identity-to-Function-App"><a class="header-anchor" href="#Assign-Managed-Identity-to-Function-App"></a>Assign Managed Identity to Function App</h3>
<p>You have two options when it comes to choosing a Managed Identity: System Assigned or User Assigned. With System Assigned Azure will create the identity on your behalf, with User Assigned, you first create the identity and then assign it.  User assigned is useful when you want to reuse the identity across multiple Azure resources.</p>
<h4 id="Option-1-Assign-a-System-Assigned-Managed-Identity-to-Function-App"><a class="header-anchor" href="#Option-1-Assign-a-System-Assigned-Managed-Identity-to-Function-App"></a>Option 1: Assign a System Assigned Managed Identity to Function App</h4>
<p>This will enabled a Managed Identity for the Function App and assign it the Storage Blob Data Contributor role.  You don’t have to individually create a Managed Identity and assign it roles - you can do it all in this one command.</p>
<pre class="line-numbers language-bash"><code class="language-bash">az functionapp identity assign -n FUNCTION_APP_NAME -g RESOURCE_GROUP_NAME --role ba92f5b4-2d11-453d-a403-e96b0029c9fe --scope /subscriptions/SUBSCRIPTION_ID
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>FUNCTION_APP_NAME</code> The function app name you created earlier.</li>
<li><code>RESOURCE_GROUP_NAME</code> The resource group you created earlier.</li>
<li><code>SUBSCRIPTION_ID</code> - The subscription id that the function is in. Run <code>az account show</code> to get this value.</li>
<li><code>--role</code> - The GUID <code>ba92f5b4-2d11-453d-a403-e96b0029c9fe</code> is the ID for the Storage Blob Data Contributor role.  You can find all of the built-in Azure roles here: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles">Built-in roles for Azure resources</a></li>
</ul>
<h4 id="Option-2-Assign-a-User-Assigned-Managed-Identity-to-Function-App"><a class="header-anchor" href="#Option-2-Assign-a-User-Assigned-Managed-Identity-to-Function-App"></a>Option 2: Assign a User Assigned Managed Identity to Function App</h4>
<p>With this option, you first create the Managed Identity and then assign it to the Function App.  This is useful if you want to reuse the identity for multiple resources, but Azure still manages it the way it manages system assigned identities.</p>
<ol>
<li>Create the User Assigned Managed Identity</li>
</ol>
<pre class="line-numbers language-bash"><code class="language-bash">az identity create -g RESOURCE_GROUP_NAME -n USER_ASSIGNED_IDENTITY_NAME
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>RESOURCE_GROUP_NAME</code> The resource group you created earlier.</li>
<li><code>USER_ASSIGNED_IDENTITY_NAME</code> A unique identity name that you create.</li>
</ul>
<ol start="2">
<li>Get the User Assigned Managed Identity Metadata</li>
</ol>
<p>We are going to need the resource id and client id in a minute, so let’s get them now.</p>
<pre class="line-numbers language-bash"><code class="language-bash">az identity list -g RESOURCE_GROUP_NAME
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>RESOURCE_GROUP_NAME</code> The resource group you created earlier.</li>
</ul>
<blockquote>
<p>Copy the <code>clientId</code> and <code>id</code>, you will need it in later steps.</p>
</blockquote>
<ol start="3">
<li>Assign the Storage Blob Data Contributor Role to the User Assigned Identity</li>
</ol>
<pre class="line-numbers language-bash"><code class="language-bash">az role assignment create --assignee USER_ASSIGNED_IDENTITY_CLIENT_ID --role ba92f5b4-2d11-453d-a403-e96b0029c9fe
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>USER_ASSIGNED_IDENTITY_CLIENT_ID</code> This is the “clientId” property that you retrieved in the last step.</li>
<li><code>--role</code> - The GUID <code>ba92f5b4-2d11-453d-a403-e96b0029c9fe</code> is the ID for the Storage Blob Data Contributor role.  You can find all of the built-in Azure roles here: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles">Built-in roles for Azure resources</a></li>
</ul>
<ol start="4">
<li>Assign the User Assigned Identity to the Function App</li>
</ol>
<pre class="line-numbers language-bash"><code class="language-bash">az functionapp identity assign -n FUNCTION_APP_NAME -g RESOURCE_GROUP_NAME --identities USER_ASSIGNED_IDENTITY_RESOURCE_ID
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>FUNCTION_APP_NAME</code> The function app name you created earlier.</li>
<li><code>RESOURCE_GROUP_NAME</code> The resource group you created earlier.</li>
<li><code>USER_ASSIGNED_IDENTITY_RESOURCE_ID</code> The complete Azure resource id for the user assigned identity, which you retrieved earlier. USER_ASSIGNED_IDENTITY_RESOURCE_ID below is the complete path to the Resource in Azure, not a GUID, not a clientId, it looks something like this: <code>/subscriptions/25fd0362-aa79-488b-b37b-d6e892009fdf/resourcegroups/jgfnrg1/providers/Microsoft.ManagedIdentity/userAssignedIdentities/jgfnmanid1</code></li>
</ul>
<ol start="5">
<li>Set Environment Variables</li>
</ol>
<p>Because you are using a User Assigned Managed Identity, we are going to have to manually set some Environment Variables to explicitly tell Azure which Identity to use:</p>
<pre class="line-numbers language-bash"><code class="language-bash">az functionapp config appsettings set -n FUNCTION_APP_NAME -g RESOURCE_GROUP_NAME --settings "AZURE_CLIENT_ID=USER_ASSIGNED_IDENTITY_CLIENTID" "AZURE_TENANT_ID=TENANT_ID"
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>FUNCTION_APP_NAME</code> The function app name you created earlier.</li>
<li><code>RESOURCE_GROUP_NAME</code> The resource group you created earlier.</li>
<li><code>USER_ASSIGNED_IDENTITY_CLIENTID</code> This is the client id for the user assigned managed identity that you created earlier</li>
<li><code>TENANT_ID</code> This is the Azure tenant that your subscription lives in - you can find this with <code>az account show --query tenantId -o tsv</code>.</li>
</ul>
<p>If you don’t do this, then you’ll likely see the following exception later in the logstream.  (See below for info on how to view the logstream)</p>
<pre class="line-numbers language-json"><code class="language-json">&amp;#123;"statusCode":400,"message":"Unable to load requested managed identity.","correlationId":"fc7504dd-c16c-4526-b8a8-667f6463d306"&amp;#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Now that you have your Managed Identity configured it is time to deploy our Function to Azure.</p>
<h3 id="Deploy-Azure-Function-to-Azure"><a class="header-anchor" href="#Deploy-Azure-Function-to-Azure"></a>Deploy Azure Function to Azure</h3>
<p>We are now FINALLY ready to deploy the Azure Function to Azure and test it out.</p>
<ol>
<li>Deploy the Function</li>
</ol>
<p>Open a terminal and execute the following command to deploy your local function to Azure.  There are many ways to deploy an Azure Function, for this example we’ll use the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=windows#publish">Azure Function Core Tools</a></p>
<pre class="line-numbers language-bash"><code class="language-bash">func azure functionapp publish FUNCTION_APP_NAME

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>FUNCTION_APP_NAME</code> The function app name you created earlier.</li>
</ul>
<p>Notes:</p>
<ul>
<li>If you see the following exception, then try again in a few minutes.  I got this error. Waiting a few minutes, ran it again and it worked:</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">Getting site publishing info...
Creating archive for current directory...
Uploading 3.19 MB [###############################################################################]
Upload completed successfully.
Deployment completed successfully.
Response status code does not indicate success: 400 (Bad Request).
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>This step can take a few minutes and may not work the first time.  If you don’t get back a URL, then keep trying until you do.  You may see output like this last doesn’t include the URL. Just try again.</li>
</ul>
<ol start="2">
<li>Test the Function</li>
</ol>
<p>Once it has been successfully deployed, it will output the Function URL</p>
<pre class="line-numbers language-bash"><code class="language-bash">Getting site publishing info...
Creating archive for current directory...
Uploading 2.97 MB [###############################################################################]
Upload completed successfully.
Deployment completed successfully.
Functions in jgfnapp1:
    upload - [httpTrigger]
        Invoke url: https://jgfnapp1.azurewebsites.net/api/upload?code=CR
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Go to that URL to execute the function and verify that a file was uploaded.</p>
<p><img src="000071.png" alt=""></p>
<p>Notes:</p>
<ul>
<li>If it doesn’t succeed right away, give it a few minutes to cycle, restart the app, and try again.</li>
<li>If you see the following error, you’ll want to verify that your Managed Identity is configured correctly.</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">2020-01-31T23:38:19.117 [Error] Executed 'func1' (Failed, Id=09062b19-c7e8-45f6-a9bc-d828d47adbb2)
Environment variables not fully configured. AZURE_TENANT_ID and AZURE_CLIENT_ID must be set, along with either AZURE_CLIENT_SECRET or AZURE_USERNAME and AZURE_PASSWORD. Currently set variables [  ]
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>You can view the Managed Identities assigned to your Function by executing the following command:</p>
<pre class="line-numbers language-bash"><code class="language-bash">az resource list -n FUNCTION_APP_NAME -g RESOURCE_GROUP_NAME
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Which will output something like this:</p>
<pre class="line-numbers language-json"><code class="language-json">&amp;#123;
    "id": "/subscriptions/25fd0362-aa79-488b-b37b-d6e892009fdf/resourceGroups/jgfnrg1/providers/Microsoft.Web/sites/jgfnapp1",
    "identity": &amp;#123;
      "principalId": "ca9937fe-2967-443b-99c1-c480bf6000dd",
      "tenantId": "72f988bf-86f1-41af-91ab-2d7cd011db47",
      "type": "SystemAssigned",
      "userAssignedIdentities": null
    &amp;#125;,
    "kind": "functionapp,linux,container",
    "location": "westus2",
    "managedBy": null,
    "name": "jgfnapp1",
    "plan": null,
    "properties": null,
    "resourceGroup": "jgfnrg1",
    "sku": null,
    "tags": null,
    "type": "Microsoft.Web/sites"
&amp;#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li>Debug the Function</li>
</ol>
<p>If you get any failures, or if you just want to view the logs you can view the Function App logstream.</p>
<p>You have a couple of options:</p>
<p><strong>Option 1: VS Code Debugging</strong></p>
<p>If you have VS Code and the VS Code Functions extension, you can just hit F5 and step through your code.</p>
<p><strong>Option 2: Azure Functions VS Code Extension</strong></p>
<p>Open the Azure VS Code extension, expand FUNCTIONS, find your Function, right-click and select “Start Streaming Logs”.  That will open the Azure portal and you can view your logs.</p>
<p><img src="000050.png" alt=""></p>
<p>You can install the VS Code extension here: <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions">Install Azure Functions VS Code Extension (Optional)</a></p>
<p><strong>Option 3: Azure Functions Core Tools</strong></p>
<p>You can also view the logstream via the terminal using the Azure Function Core Tools</p>
<pre class="line-numbers language-bash"><code class="language-bash">func azure functionapp logstream FUNCTION_APP_NAME
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Parameters:</p>
<ul>
<li><code>FUNCTION_APP_NAME</code> The function app name you created earlier.</li>
</ul>
<p><strong>Option 4: Azure Portal</strong></p>
<p>Go to the Azure Portal and find your Azure Function.  You can run it from within the browser and see return codes and exceptions.</p>
<ol start="4">
<li>Verify Success with Storage Explorer</li>
</ol>
<p>Open Storage Explorer and navigate to: <code>Subscription -&gt; Storage Accounts -&gt; Storage Account -&gt; Blob Containers -&gt; azfuncblobs</code></p>
<p>Verify that your file has been successfully uploaded.</p>
<h2 id="Conclusion"><a class="header-anchor" href="#Conclusion"></a>Conclusion</h2>
<p>We covered a lot in this series. My hope is that learning about the 3 different combinations of local and cloud dev with Managed Identities and the new <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/azure.identity.defaultazurecredential?view=azure-dotnet"><code>Azure Identity DefaultAzureCredential</code></a> will help you be more productive.</p>
<p>Part 1: <a href="/azure-functions-blob-managed-identity-part1">Local Function with Storage Emulator (local function, local storage)</a><br>
Part 2: <a href="/azure-functions-blob-managed-identity-part2">Local Function with Azure Storage and Service Principal (local function, cloud storage)</a><br>
Part 3: Azure Function with Azure Storage and Managed Identity (cloud function, cloud storage)</p>
<p>Please leave a comment below if you found this post helpful or need help with any of this.</p>
<p>Jon</p>

        </div>
        <footer>
        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar">
        <i class="toggle icon"></i>
    </a>
    <div class="sidebar-top">

        <ul class="social-links">
            
            
            <li>
                <a class="social-tooltip" title="twitter" href="http://twitter.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-twitter"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="github" href="https://github.com/jongio"
                    target="_blank">
                    <i class="icon fa fa-github"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="rss" href="http://feeds.feedburner.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-rss"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="linkedin" href="http://www.linkedin.com/in/jongallant"
                    target="_blank">
                    <i class="icon fa fa-linkedin"></i>
                </a>
            </li>
            
            
            
            <li>
                <a class="social-tooltip" title="youtube" href="https://www.youtube.com/jongallant"
                    target="_blank">
                    <i class="icon fa fa-youtube"></i>
                </a>
            </li>
            
            
        </ul>
    </div>
    
    
    <nav id="article-nav">
        
            <a href="/2020/02/azurite-https-defaultazurecredential/" id="article-nav-newer" class="article-nav-link-wrap">
                <strong class="article-nav-caption">
                    newer
                </strong>
                <p class="article-nav-title">
                    
                        Use HTTPS and DefaultAzureCredential with Azurite for Local Azure Storage Emulation
                            
                </p>
                <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>

            </a>
            
                
                    <a href="/2020/02/azure-functions-blob-managed-identity-part2/" id="article-nav-older" class="article-nav-link-wrap">
                        <strong class="article-nav-caption">
                            older
                        </strong>
                        <p class="article-nav-title">
                            How to Upload Blobs to Azure Storage from an Azure Function with Azure Managed Identities (Part 2)
                        </p>
                        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>

                    </a>
                    
    </nav>
    
    

    <div class="widgets-container">
        
        
        <br/>
<div style="position:relative;height:0;padding-bottom:56.25%"><iframe src="https://www.youtube.com/embed/videoseries?list=PLiMIJTv6gK5_Zmdcmbo-kxAbpeGjSou9x&amp;showinfo=0?ecver=2" width="640" height="360" frameborder="0" gesture="media" allow="encrypted-media" style="position:absolute;width:100%;height:100%;left:0" allowfullscreen></iframe></div>
<br/>
        
        <div class="github-card" data-github="jongio" data-width="340" data-height="150" data-theme="default"></div>
<script src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
        
        <a class="twitter-timeline" data-height="700" target="_blank" rel="noopener" href="https://twitter.com/jongallant?ref_src=twsrc%5Etfw"></a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        
        
        <div class="rail-ad">
            <!-- rail -->
            <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-7253926757222509"
            data-ad-slot="7222147978"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>

            <!-- 2nd rail -->
            <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-7253926757222509"
            data-ad-slot="1523952970"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </div>
</aside>
                </div>
            </div>
        </div>
        <div class="banner-ad">
   <!-- footer -->
    <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-7253926757222509"
    data-ad-slot="5729050190"
    data-ad-format="auto"
    data-full-width-responsive="true"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo-n"></a>
                </h1>
                <p>&copy;
                    2023
                    Jon Gallant
                </p>
                <p>Disclaimer: The opinions expressed herein are my own personal opinions and do not represent my
                    employer’s view in any way. This post may contain affiliate links. If you use these links to buy something I may earn a commission.</p>
            </div>

        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'jongallant';
    
    
    var disqus_url = 'https://blog.jongallant.com/2020/02/azure-functions-blob-managed-identity-part3/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




<!-- Custom Scripts -->
<!-- 
<script src="/js/main.js"></script>
 -->
<script src="/js/main.js?1"> </script>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js" integrity="sha512-xR+IAyN+t9EBIOOJw5m83FTVMDsPd63IhJ3ElP4gmfUFnQlX9+eWGLp3P4t3gIjpo2Z1JzqtW/5cjgn+oru3yQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-zc7WDnCM3aom2EziyDIRAtQg1mVXLdILE09Bo+aE1xk0AM2c2cVLfSW9NrxE5tKTX44WBY0Z2HClZ05ur9vB6A==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-br8H6OngKoLht57WKRU5jz3Vr0vF+Tw4G6yhNN2F3dSDheq4JiaasROPJB1wy7PxPk7kV/+5AIbmoZLxxx7Zow==" crossorigin="anonymous"></script>
</body>

</html>